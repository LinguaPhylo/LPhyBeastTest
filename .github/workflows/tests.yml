name: LPhy BEAST tests
on: [ push, pull_request, workflow_dispatch ]

# not support var in the path
env:
  BEAST_DIR: beast2.6.7
  LPHY_DIR:  lphy-studio-1.3.0

jobs:
  setup-lphybeast:
    runs-on: ubuntu-latest

    # note: not support var containing var
    # $BEAST is reserved in all scripts
    steps:
      - name: Set environmental variables
        run: |
          echo "BEAST=$GITHUB_WORKSPACE/$BEAST_DIR" >> $GITHUB_ENV
          echo "LPHY_SCRIPTS=$GITHUB_WORKSPACE/$BEAST_DIR/$LPHY_DIR/tutorials" >> $GITHUB_ENV
          echo "LPHY_BEAST_DIR=$GITHUB_WORKSPACE/beast2" >> $GITHUB_ENV
          echo "XML_DIR=$GITHUB_WORKSPACE/lphybeast" >> $GITHUB_ENV

      - name: Checkout main
        uses: actions/checkout@v2
      # this must be after main
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: 17
          distribution: 'adopt'
          #cache: 'gradle'

      #TODO beagle
      - name: Build beagle
        run: |
          apt-get install -y build-essential autoconf automake libtool pkg-config
          pwd
          git clone --branch v3.0.1 --depth=1 https://github.com/beagle-dev/beagle-lib.git
          cd beagle-dev/beagle-lib
          ls
          ./autogen.sh 
          ./configure --prefix=/usr/local 
          make install
          ldconfig
          $BEAST/bin/beast -beagle_info

      # install lphybeast, lphybeast-ext https://www.beast2.org/managing-packages/
      # added -Dbeast.user.package.dir=$LPHY_BEAST_DIR into bin/packagemanager
      # $BEAST_DIR/bin/packagemanager -list
      - name: Install lphybeast
        run: |
          pwd
          echo "ls $BEAST"
          ls $BEAST
          $BEAST/bin/packagemanager -dir $LPHY_BEAST_DIR -add lphybeast
          $BEAST/bin/packagemanager -dir $LPHY_BEAST_DIR -add LPhyBeastExt
          echo "ls $LPHY_BEAST_DIR"
          ls $LPHY_BEAST_DIR
          echo "ls $LPHY_SCRIPTS"
          ls $LPHY_SCRIPTS
          mkdir $XML_DIR

      - name: Create and run RSV2 XML
        run: |
          pwd
          ls -l .
          $BEAST/bin/lphybeast -o $XML_DIR/RSV2.xml $LPHY_SCRIPTS/RSV2.lphy
          $BEAST/bin/beast -working $XML_DIR/RSV2.xml

      - name: Create and run hcv_coal XML
        run: |
          $BEAST/bin/lphybeast -o $XML_DIR/hcv_coal.xml $LPHY_SCRIPTS/hcv_coal.lphy
          $BEAST/bin/beast -working $XML_DIR/hcv_coal.xml

      - name: Create and run h5n1 XML
        run: |
          $BEAST/bin/lphybeast -o $XML_DIR/h5n1.xml $LPHY_SCRIPTS/h5n1.lphy
          $BEAST/bin/beast -working $XML_DIR/h5n1.xml

      - name: Create and run h3n2 XML
        run: |
          $BEAST/bin/lphybeast -o $XML_DIR/h3n2.xml $LPHY_SCRIPTS/h3n2.lphy
          $BEAST/bin/beast -working $XML_DIR/h3n2.xml

      - name: Analyse log and annotate trees
        run: |
          cd $XML_DIR
          pwd
          ls .
          $BEAST/bin/loganalyser RSV2.log
          $BEAST/bin/treeannotator -burnin 10 -heights mean RSV2.trees RSV2.tree
          $BEAST/bin/loganalyser hcv_coal.log
          $BEAST/bin/treeannotator -burnin 10 -heights mean hcv_coal.trees hcv_coal.tree
          $BEAST/bin/loganalyser h5n1.log
          $BEAST/bin/treeannotator -burnin 10 -heights mean h5n1.trees h5n1.tree
          $BEAST/bin/loganalyser h3n2.log
          $BEAST/bin/treeannotator -burnin 10 -heights mean h3n2.trees h3n2.tree

#TODO more h5n1 post analyses
